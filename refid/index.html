<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>RefID - ID the refrigerant in unknown bottles</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* mobile list-group helpers */
    .mobile-listbox {
      max-height: 320px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: .25rem;
    }
    header img.logo { height:100px; width:auto; }

    /* preserve notice spacing */
    .notice { margin-bottom:1rem; }

    /* hide native selects on mobile, show list-groups on mobile */
    .hidden-on-mobile { display: block; }
    @media (max-width: 767.98px) {
      .hidden-on-mobile { display: none !important; }
      .visible-on-mobile { display: block !important; }
    }
    @media (min-width: 768px) {
      .visible-on-mobile { display: none !important; }
    }


  </style>
</head>
<body>
  <header class="bg-primary text-white py-3 mb-4 shadow-sm">
    <div class="container d-flex flex-column flex-md-row align-items-center justify-content-center gap-3">
      <img src="logo.png" alt="RefID Logo" class="logo">
      <h1 class="h3 m-0">v1.0</h1>
    </div>
  </header>

  <main class="container">
    <div class="alert alert-info notice" id="notice">
      Lookup list improves accuracy and reduces API calls. 
    </div>

    <!-- Controls -->
    <div class="row g-3 align-items-end mb-4">
      <div class="col-6 col-sm-4 col-md-2">
        <label class="form-label">Temperature:</label>
        <input type="number" id="tempInput" value="16" class="form-control">
      </div>

      <div class="col-6 col-sm-4 col-md-2">
        <label class="form-label">Pressure:</label>
        <input type="number" id="pressInput" value="160" class="form-control">
      </div>

      <div class="col-6 col-sm-4 col-md-2">
        <label class="form-label">Phase:</label>
        <select id="phaseRef" class="form-select">
          <option value="bubble">Bubble</option>
          <option value="dew">Dew</option>
        </select>
      </div>

      <div class="col-6 col-sm-4 col-md-2">
        <label class="form-label">Pressure type:</label>
        <select id="pressType" class="form-select">
          <option value="gauge">Gauge</option>
          <option value="absolute">Absolute</option>
        </select>
      </div>

      <div class="col-6 col-sm-4 col-md-2">
        <label class="form-label">Pressure unit:</label>
        <select id="pressUnit" class="form-select">
          <option value="psi">psi</option>
          <option value="bar">bar</option>
        </select>
      </div>

      <div class="col-6 col-sm-4 col-md-2">
        <label class="form-label">Temp unit:</label>
        <select id="tempUnit" class="form-select">
          <option value="C">°C</option>
          <option value="F">°F</option>
        </select>
      </div>

      <div class="col-6 col-sm-4 col-md-3">
        <label class="form-label">Sort by:</label>
        <select id="sortMode" class="form-select">
          <option value="pct">Δ %</option>
          <option value="abs">Δ abs</option>
        </select>
      </div>

      <div class="col-6 col-sm-4 col-md-3 d-grid">
        <button id="btnClear" class="btn btn-secondary">Clear</button>
      </div>

      <div class="col-12 col-md-2 d-grid">
        <button id="btnCheck" class="btn btn-primary">Find matches</button>
      </div>
    </div>

    <!-- Lists -->
    <div class="row g-4 mb-4">
      <div class="col-md-6">
        <label for="lookupList" class="form-label">Lookup list (common)</label>

        <!-- Desktop native select (visible on md+) -->
        <select id="lookupList" multiple size="10" class="form-select hidden-on-mobile w-100"></select>

        <!-- Mobile list-group (visible on xs-sm) -->
        <div id="lookupListMobile" class="visible-on-mobile mobile-listbox list-group"></div>

        <div class="d-flex flex-wrap gap-2 mt-2">
          <button id="btnResetCommon" class="btn btn-warning btn-sm">Reset defaults</button>
          <button id="btnSave" class="btn btn-primary btn-sm">Save lookup (localStorage)</button>
          <button id="removeAllBtn" class="btn btn-danger btn-sm">Remove All</button>
          <button id="btnClearLookup" class="btn btn-secondary btn-sm">Remove selected from lookup</button>
        </div>
      </div>

      <div class="col-md-6">
        <label for="allList" class="form-label">All refrigerants</label>

        <!-- Desktop native select -->
        <select id="allList" multiple size="10" class="form-select hidden-on-mobile w-100"></select>

        <!-- Mobile list-group -->
        <div id="allListMobile" class="visible-on-mobile mobile-listbox list-group"></div>

        <div class="d-flex flex-wrap gap-2 mt-2">
          <button id="btnAdd" class="btn btn-primary btn-sm">➕ Add selected to lookup</button>
          <button id="selectAllBtn" class="btn btn-success btn-sm">Select all</button>
          <button id="btnClearLookup" class="btn btn-danger btn-sm">Remove selected from lookup</button>
        </div>
      </div>
    </div>

    <!-- Mode toggle 
    <div class="mode-toggle mb-3">
      <div class="btn-group" role="group" aria-label="data mode">
        <input type="radio" class="btn-check" name="dataMode" id="mode-offline" value="offline" autocomplete="off" checked>
        <label class="btn btn-outline-success" for="mode-offline">Offline DB</label>

        <input type="radio" class="btn-check" name="dataMode" id="mode-live" value="live" autocomplete="off">
        <label class="btn btn-outline-danger" for="mode-live">Live API</label>
      </div>
    </div> 
  -->

    <!-- Results -->
    <div id="results">
      <small>Results appear here after pressing "Find matches".</small>
    </div>

    <!-- Disclaimer -->
    <div id="disclaimer" class="alert alert-info mt-3"><small>
      <p/>Disclaimer<p/>
      This application is provided on an "as is" and "as available" basis for the intended purposes as determined by the site owner only and any use hereof is at the user's sole risk. The Application and results and information generated thereby cannot substitute technical advice but must be verified by the user, they are not promises and should not be relied on as accurate data or analyses.
      <br/>
      The site owner disclaims all warranties and conditions regarding the Application, whether express, implied, or statutory, including, but not limited to, conditions of merchantability, satisfactory quality, fitness for a particular purpose, accuracy and non-infringement of third parties’ rights. the site owner does not warrant that the Application will meet your requirements or that the operation hereof will be uninterrupted or error-free.
      <br/>
      To the extent not prohibited by law, in no event shall the site owner be liable for any direct, special, indirect or consequential damages, whatsoever, including, without limitation, damage to property, damages for loss of savings or profits, or loss of data arising out of any use of the Application.
    </small></div>

  </main>

  <footer class="bg-primary text-white text-center py-3 mt-4">
    © 2025 RefID. All rights reserved.
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- App script -->
  <script>
/* ----- configuration ----- */
const COMMON_DEFAULTS = [
  "R134a","R22","R410A","R404A","R407C","R32","R1234yf","R290","R600a",
  "R123","R124","R125","R152a","R717","R744","R502","R507","R401A"
];
const ALL_FLUIDS = [
  "R11","R12","R13","R13B1","R14","R22","R23","R32","R41","R114","R123","R1150",
  "R1233zd(E)","R1234yf","R1234ze(E)","R124","R125","R1270","R1336mzz(Z)","R134a",
  "R141b","R142b","R152a","R170","R227ea","R236ea","R236fa","R245fa","R290",
  "R401A","R401B","R402A","R402B","R403B","R404A","R406A","R407A","R407B",
  "R407C","R407F","R407H","R408A","R409A","R409B","R410A","R413A","R414B","R416A",
  "R417A","R417C","R420A","R421A","R422A","R422B","R422C","R422D","R424A","R426A",
  "R427A","R428A","R434A","R436A","R436B","R436C","R437A","R438A","R441A","R442A",
  "R443A","R444A","R444B","R445A","R448A","R449A","R449B","R450A","R452A","R452B",
  "R453A","R454A","R454B","R454C","R455A","R458A","R466A","R469A","R470A","R470B",
  "R471A","R472A","R472B","R473A","R50","R500","R502","R503","R507","R508B","R511A",
  "R513A","R513B","R514A","R515A","R515B","R516A","R600","R600a","R601","R601a","R702",
  "R717","R718","R723","R728","R729","R732","R744","R744A","RE170"
];

/* ----- DOM elements ----- */
const lookupSelect = document.getElementById('lookupList');
const allSelect = document.getElementById('allList');
const lookupMobile = document.getElementById('lookupListMobile');
const allMobile = document.getElementById('allListMobile');

const btnAdd = document.getElementById('btnAdd');
const btnCheck = document.getElementById('btnCheck');
const resultsDiv = document.getElementById('results');
const tempInput = document.getElementById('tempInput');
const presInput = document.getElementById('pressInput');
const sortMode = document.getElementById('sortMode');
const btnResetCommon = document.getElementById('btnResetCommon');
const btnSave = document.getElementById('btnSave');
const btnClearLookup = document.getElementById('btnClearLookup');
const btnClear = document.getElementById('btnClear');
const selectAllBtn = document.getElementById('selectAllBtn');
const removeAllBtn = document.getElementById('removeAllBtn');

const phaseSelect = document.getElementById('phaseRef');
const pressTypeSelect = document.getElementById('pressType');
const pressUnitSelect = document.getElementById('pressUnit');
const tempUnitSelect = document.getElementById('tempUnit');

/* ----- NEW: mode toggle ----- */
let offlineDB = null;
let dataMode = "offline";

/* ----- load offline DB  ----- */
async function loadOfflineDB() {
  try {
    const resp = await fetch('https://refid-worker.oliemery311.workers.dev/api/refrigerants');
    if (!resp.ok) throw new Error(`Worker fetch failed: ${resp.status}`);
    offlineDB = await resp.json();  // object keyed by refrigerant names
    console.log('Offline DB loaded', Object.keys(offlineDB).length, 'records');
  } catch (e) {
    console.error('Failed to load offline DB', e);
    offlineDB = {};
  }
}

/* ----- mobile detection helper ----- */
function isMobileTouch() {
  return (('ontouchstart' in window) || navigator.maxTouchPoints > 0) && window.innerWidth < 768;
}

/* ----- UI helpers: populate lists (selects) ----- */
function populateAllAndLookup() {
  // populate desktop allList select
  allSelect.innerHTML = '';
  ALL_FLUIDS.forEach(f => {
    const o = document.createElement('option'); o.value = f; o.text = f;
    allSelect.appendChild(o);
  });

  // rebuild mobile all list if present
  if (allMobile) rebuildMobileListFromSelect(allSelect, allMobile);

  // populate lookup select (from localStorage or defaults)
  const saved = localStorage.getItem('ptmatcher_lookup');
  const useList = saved ? JSON.parse(saved) : COMMON_DEFAULTS;
  updateLookup(useList);
}

function updateLookup(arrayOfNames) {
  lookupSelect.innerHTML = '';
  arrayOfNames.forEach(r => {
    const o = document.createElement('option'); o.value = r; o.text = r;
    lookupSelect.appendChild(o);
  });

  // rebuild mobile lookup UI
  if (lookupMobile) rebuildMobileListFromSelect(lookupSelect, lookupMobile);
}

/* ----- mobile list rebuild (creates Bootstrap list-group items from the select options) ----- */
function rebuildMobileListFromSelect(selectEl, mobileContainer) {
  if (!mobileContainer) return;
  mobileContainer.innerHTML = '';
  Array.from(selectEl.options).forEach(opt => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'list-group-item list-group-item-action' + (opt.selected ? ' active' : '');
    btn.textContent = opt.text;
    btn.dataset.value = opt.value;
    btn.addEventListener('click', () => {
      // toggle selection state
      opt.selected = !opt.selected;
      btn.classList.toggle('active', opt.selected);
    });
    mobileContainer.appendChild(btn);
  });
}

/* ----- selection helpers used by UI buttons ----- */
btnResetCommon.addEventListener('click', () => updateLookup(COMMON_DEFAULTS));

btnSave.addEventListener('click', () => {
  const arr = [...lookupSelect.options].map(o => o.value);
  localStorage.setItem('ptmatcher_lookup', JSON.stringify(arr));
  alert('Saved lookup list.');
});

btnAdd.addEventListener('click', () => {
  const selected = [...(isMobileTouch() ? Array.from(allSelect.options).filter(o=>o.selected) : allSelect.selectedOptions)].map(o => o.value);
  const existing = new Set([...lookupSelect.options].map(o => o.value));
  selected.forEach(sv => {
    if (!existing.has(sv)) {
      const opt = document.createElement('option'); opt.value = sv; opt.text = sv;
      lookupSelect.appendChild(opt);
    }
  });
  // refresh mobile lookup UI
  if (lookupMobile) rebuildMobileListFromSelect(lookupSelect, lookupMobile);
});

btnClearLookup.addEventListener('click', () => {
  const toRemove = new Set([...lookupSelect.selectedOptions].map(o => o.value));
  if (isMobileTouch() && lookupMobile) {
    const actives = [...lookupMobile.querySelectorAll('.list-group-item.active')].map(b => b.dataset.value);
    actives.forEach(v => toRemove.add(v));
  }

  for (let i = lookupSelect.options.length-1; i>=0; i--) {
    if (toRemove.has(lookupSelect.options[i].value)) lookupSelect.remove(i);
  }
  if (lookupMobile) rebuildMobileListFromSelect(lookupSelect, lookupMobile);
});

document.getElementById('selectAllBtn')?.addEventListener('click', () => {
  const allRefrigerants = ALL_FLUIDS.slice();
  updateLookup(allRefrigerants);
  localStorage.setItem('ptmatcher_lookup', JSON.stringify(allRefrigerants));
  console.log("[DEBUG] Lookup after Select All:", allRefrigerants);
});

document.getElementById('removeAllBtn')?.addEventListener('click', () => {
  updateLookup([]);
  localStorage.setItem('ptmatcher_lookup', JSON.stringify([]));
  console.log("[DEBUG] Lookup cleared");
});

btnClear?.addEventListener('click', () => {
  tempInput.value = '';
  presInput.value = '';
  resultsDiv.innerHTML = '<small>Results appear here after pressing "Find matches".</small>';
});

/* ----- helper: pressure conversion ----- */
function convertPressure(val, fromUnit, toUnit) {
  if (val == null) return null;
  if (fromUnit === toUnit) return val;
  if (fromUnit === "bar" && toUnit === "psi") return val * 14.5038;
  if (fromUnit === "psi" && toUnit === "bar") return val / 14.5038;
  return val;
}

/* ----- main matching ----- */
async function getPressure(ref, temp) {
  const refKey = ref.toUpperCase();

  if (dataMode === "live") {
    const payload = {
      temperature: String(temp),
      refId: ref.toLowerCase(),
      temperatureUnit: tempUnitSelect.value.toLowerCase() === 'f' ? "fahrenheit" : "celsius",
      pressureUnit: pressUnitSelect.value.toLowerCase(),
      pressureReferencePoint: pressTypeSelect.value.toLowerCase(),
      pressureCalculationPoint: phaseSelect.value.toLowerCase(),
      gaugeType: "dry",
      altitudeInMeter: 0
    };

    const resp = await fetch(`https://some.refrigerant.api/api${ref.toLowerCase()}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (!resp.ok) throw new Error(`API error ${resp.status}`);
    const text = await resp.text();
    return parseFloat(text);

  } else {
    if (!offlineDB) await loadOfflineDB();

    const key = Object.keys(offlineDB).find(k => k.toUpperCase() === ref.toUpperCase());
    if (!key) {
      console.warn(`No data found for refrigerant: ${ref}`);
      return null;
    }

    const r = offlineDB[key];
    const tempKeys = Object.keys(r).map(k => Number(k));
    if (tempKeys.length === 0) return null;

    const closestTemp = tempKeys.reduce((prev, curr) =>
      Math.abs(curr - temp) < Math.abs(prev - temp) ? curr : prev
    );

    const tempData = r[closestTemp];
    const phase = phaseSelect.value.toLowerCase();
    const pressType = pressTypeSelect.value.toLowerCase();

    const PsatBar = tempData[phase][pressType];
    const Psat = convertPressure(PsatBar, 'bar', pressUnitSelect.value.toLowerCase());

    return Psat ?? null;
  }
}

/* ----- check matches ----- */
btnCheck.addEventListener('click', async () => {
  const T = tempInput.value;
  const Pinput = parseFloat(presInput.value);
  if (!T || isNaN(Pinput)) {
    resultsDiv.innerHTML = '<div class="alert alert-danger">Enter numeric temperature & pressure.</div>';
    return;
  }

  if (isMobileTouch() && lookupMobile) {
    const actives = new Set([...lookupMobile.querySelectorAll('.list-group-item.active')].map(b => b.dataset.value));
    for (const o of lookupSelect.options) o.selected = actives.has(o.value);
  }

  const candidates = [...lookupSelect.options].map(o => o.value);
  const out = [];

  for (const fluid of candidates) {
    try {
      console.log(`Processing fluid: ${fluid}`);
      const Psat = await getPressure(fluid, T);
      // console.log(`Psat for ${fluid}:`, Psat);

      if (Psat == null) continue;

      const Ppsi = Psat;
      const diffPct = (Pinput - Ppsi) / Ppsi * 100;
      const diffVal = Pinput - Ppsi;
      out.push({ fluid, Psat, Ppsi, diffPct, diffVal });
    } catch (e) {
      console.warn(`Failed ${fluid}:`, e);
    }
  }

  if (out.length === 0) {
    resultsDiv.innerHTML = '<div class="alert alert-danger">No results returned.</div>';
    return;
  }

  if (sortMode.value === 'pct') out.sort((a, b) => Math.abs(a.diffPct) - Math.abs(b.diffPct));
  else out.sort((a, b) => Math.abs(a.diffVal) - Math.abs(b.diffVal));

  renderResults(out);
});

/* ----- present results using Bootstrap table ----- */
function renderResults(data) {
  // Guard
  if (!data || data.length === 0) {
    resultsDiv.innerHTML = '<div class="alert alert-danger">No results returned.</div>';
    return;
  }

  // Helper: try multiple candidate keys and return first non-undefined value
  function pick(row, keys) {
    for (const k of keys) {
      if (row == null) continue;
      if (Object.prototype.hasOwnProperty.call(row, k) && row[k] !== undefined && row[k] !== null) return row[k];
    }
    return undefined;
  }

  // Helper: parse a value to number if possible, otherwise return undefined
  function asNumber(v) {
    if (v === undefined || v === null) return undefined;
    if (typeof v === 'number') {
      if (!isFinite(v)) return undefined;
      return v;
    }
    // try parse numeric string (trim first)
    const n = Number(String(v).trim());
    return Number.isFinite(n) ? n : undefined;
  }

  // Determine unit safely (fallback to 'psi' if unavailable)
  const unit = (pressUnitSelect && pressUnitSelect.value) ? pressUnitSelect.value : 'psi';

  // For each row accept multiple property name variants
  const rowsHtml = data.map((row, i) => {
    // fluid name (must exist)
    const fluid = pick(row, ['fluid', 'id', 'name']) ?? '';

    // possible sat pressure fields
    const satRaw = pick(row, ['satP', 'Psat', 'sat', 'pressure', 'Ppsi', 'P_sat', 'PsatVal']);
    const satNum = asNumber(satRaw);

    // possible your/input pressure fields (some versions store it)
    const yourRaw = pick(row, ['yourP', 'Pinput', 'yourPinput', 'Ppsi', 'P_psi', 'Puser']);
    const yourNum = asNumber(yourRaw);

    // possible percent/delta fields
    const dpctRaw = pick(row, ['deltaPct', 'diffPct', 'delta_pct', 'dpct']);
    const dpctNum = asNumber(dpctRaw);

    const dvalRaw = pick(row, ['delta', 'diffVal', 'diff', 'deltaVal']);
    const dvalNum = asNumber(dvalRaw);

    // Format display strings carefully (if number -> fixed; else keep original)
    const satDisplay = (satNum !== undefined) ? satNum.toFixed(3) : (satRaw !== undefined ? String(satRaw) : '—');
    const yourDisplay = (yourNum !== undefined) ? yourNum.toFixed(2) : (yourRaw !== undefined ? String(yourRaw) : '—');
    const dpctDisplay = (dpctNum !== undefined) ? dpctNum.toFixed(2) : (dpctRaw !== undefined ? String(dpctRaw) : '—');
    const dvalDisplay = (dvalNum !== undefined) ? dvalNum.toFixed(2) : (dvalRaw !== undefined ? String(dvalRaw) : '—');

    // highlight classes (first = best, top3 next)
    let cls = '';
    if (i === 0) cls = 'table-success';
    else if (i <= 2) cls = 'table-warning';

    return `
      <tr class="${cls}">
        <td>${fluid}</td>
        <td>${satDisplay}</td>
        <td>${yourDisplay}</td>
        <td>${dpctDisplay}</td>
        <td>${dvalDisplay}</td>
      </tr>
    `;
  }).join('');

  // render the table exactly as before (Bootstrap markup)
  resultsDiv.innerHTML = `
    <div class="table-responsive" id="resultsTableWrapper">
      <table class="table table-striped table-hover table-bordered align-middle text-center custom-table">
        <thead class="table-primary">
          <tr>
            <th>Fluid</th>
            <th>Sat P (${unit})</th>
            <th>Your P (${unit})</th>
            <th>Δ (%)</th>
            <th>Δ</th>
          </tr>
        </thead>
        <tbody>
          ${rowsHtml}
        </tbody>
      </table>
    </div>
  `;

  // After DOM paint, check visibility and scroll/focus only if not fully visible
  requestAnimationFrame(() => {
    const wrapper = document.getElementById('resultsTableWrapper');
    if (!wrapper) return;
    wrapper.setAttribute('tabindex', '-1');

    function isFullyVisible(el) {
      const rect = el.getBoundingClientRect();
      const vh = (window.innerHeight || document.documentElement.clientHeight);
      const vw = (window.innerWidth || document.documentElement.clientWidth);
      // require element to be within both vertical and horizontal viewport bounds
      return rect.top >= 0 && rect.bottom <= vh && rect.left >= 0 && rect.right <= vw;
    }

    if (!isFullyVisible(wrapper)) {
      try {
        wrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
      } catch (err) {
        wrapper.scrollIntoView();
      }
      setTimeout(() => {
        try { wrapper.focus({ preventScroll: true }); } catch (e) { wrapper.focus(); }
      }, 350);
    } else {
      try { wrapper.focus({ preventScroll: true }); } catch (e) { wrapper.focus(); }
    }
  });
}




/* ----- initialization ----- */
populateAllAndLookup();
if (isMobileTouch()) {
  rebuildMobileListFromSelect(allSelect, allMobile);
  rebuildMobileListFromSelect(lookupSelect, lookupMobile);
}
if (dataMode === "offline") loadOfflineDB();

window.addEventListener('resize', () => {
  if (isMobileTouch()) {
    rebuildMobileListFromSelect(allSelect, allMobile);
    rebuildMobileListFromSelect(lookupSelect, lookupMobile);
  }
});
  </script>
</body>
</html>
